# ANOVA a due vie (con o senza repliche)

L’analisi della varianza a due vie estende l'ANOVA a una via per studiare l’effetto congiunto di due variabili categoriche sulla variabile risposta $Y$, che deve essere numerica e distribuita approssimativamente secondo una normale, con varianza costante.

### Struttura del problema

Si considerano due variabili categoriche:
- $x_1$ con $m$ livelli distinti
- $x_2$ con $n$ livelli distinti

Per ogni combinazione dei livelli di $x_1$ e $x_2$, si raccolgono $l$ osservazioni (dette **repliche**). Il numero totale di osservazioni sarà:

$$
N = m \cdot n \cdot l
$$

Se $l = 1$ si parla di **ANOVA senza repliche**. Se invece $l \ge 2$, si parla di **ANOVA con repliche**, e diventa possibile valutare anche l’interazione tra i due fattori.

I dati possono essere presentati in due formati:
- **Formato largo ("unstacked")**: una tabella $m \times n$ in cui ogni cella contiene $l$ osservazioni.
- **Formato lungo ("stacked")**: una tabella con $N$ righe, dove per ogni osservazione si annotano il livello di $x_1$, il livello di $x_2$ e il valore di $Y$.

Nel caso in cui il numero di repliche non sia costante per ogni combinazione, è spesso necessario riequilibrare i dati, scartando le osservazioni in eccesso per ottenere una struttura regolare.



### Modello generale

Nel caso più completo, ogni combinazione di $(x_1 = i, x_2 = j)$ ha una propria media $\mu_{ij}$, e le osservazioni sono indipendenti e normalmente distribuite:

$$
Y_{ijk} \sim \mathcal{N}(\mu_{ij}, \sigma^2), \quad i = 1,...,m;\ j = 1,...,n;\ k = 1,...,l
$$

Questo modello, detto **completo con interazioni**, ha $m \cdot n$ medie da stimare (più la varianza $\sigma^2$), e quindi richiede $l \ge 2$ per poter stimare anche la variabilità residua.



### Modello additivo (senza interazione)

Se si ipotizza che non ci sia interazione tra le due variabili, si può semplificare il modello scrivendo:

$$
\mu_{ij} = \mu + \alpha_i + \beta_j
$$

Qui:
- $\mu$ è la media globale
- $\alpha_i$ rappresenta l'effetto del livello $i$ della prima variabile ($x_1$)
- $\beta_j$ rappresenta l'effetto del livello $j$ della seconda variabile ($x_2$)

Per rendere il modello identificabile si impongono le condizioni:

$$
\sum_{i=1}^m \alpha_i = 0, \quad \sum_{j=1}^n \beta_j = 0
$$

Questa formulazione è molto utile perché permette di interpretare separatamente gli effetti delle due variabili, ed è utilizzabile anche quando non si hanno repliche ($l = 1$), a patto che non ci siano interazioni significative.



### Modello con interazione

Quando l’effetto di una variabile dipende dal livello dell’altra, si introduce un termine di interazione $\gamma_{ij}$:

$$
\mu_{ij} = \mu + \alpha_i + \beta_j + \gamma_{ij}
$$

In questo caso:
- ogni $\gamma_{ij}$ misura la deviazione rispetto al modello additivo per la cella $(i, j)$
- si impongono i vincoli:

$$
\sum_i \gamma_{ij} = 0, \quad \sum_j \gamma_{ij} = 0
$$

L’aggiunta di $\gamma_{ij}$ consente al modello di adattarsi meglio ai dati, ma rende più complessa l’interpretazione.



### Test per l’interazione

Prima di scegliere tra il modello additivo e quello con interazione, si effettua un test con le seguenti ipotesi:

- $H_0$: tutte le $\gamma_{ij} = 0$ (nessuna interazione)
- $H_1$: almeno una $\gamma_{ij} \ne 0$

Se $H_0$ viene accettata, si può utilizzare il modello additivo, riducendo anche il numero di parametri. In questo caso, se $l \ge 2$, si può persino calcolare la media per ogni combinazione $(i, j)$ e ridurre l’analisi a una ANOVA senza repliche ($l = 1$) usando le medie.

Se invece l'interazione risulta significativa, il modello additivo non è più valido e si deve mantenere il modello completo.

L’analisi della varianza a due vie prevede il confronto tra le devianze associate agli effetti riga, colonna, interazione ed errore. La struttura della devianza dipende dalla presenza o meno di repliche.



### Caso senza repliche ($l = 1$)

In assenza di repliche, non è possibile stimare l'interazione tra i fattori. Il modello è quindi il seguente:

$$
Y_{ij} \sim \mathcal{N}(\mu + \alpha_i + \beta_j,\ \sigma^2)
$$

Le devianze si calcolano come:

- **Devianza totale**:
  $$
  SS_T = \sum_{i,j} (Y_{ij} - \bar{Y}_{**})^2
  $$

- **Devianza riga**:
  $$
  SS_R = n \sum_i (\bar{Y}_{i*} - \bar{Y}_{**})^2
  $$

- **Devianza colonna**:
  $$
  SS_C = m \sum_j (\bar{Y}_{*j} - \bar{Y}_{**})^2
  $$

- **Devianza errore**:
  $$
  SS_E = \sum_{i,j} (Y_{ij} - \bar{Y}_{i*} - \bar{Y}_{*j} + \bar{Y}_{**})^2
  $$

Gradi di libertà associati:

| Fonte di variabilità | Gradi di libertà |
|-||
| Riga                 | $m - 1$          |
| Colonna              | $n - 1$          |
| Errore               | $(m - 1)(n - 1)$ |
| Totale               | $mn - 1$         |

Statistica del test (effetto riga):

$$
F_R = \frac{SS_R / (m - 1)}{SS_E / [(m - 1)(n - 1)]} \sim F(m-1, (m-1)(n-1))
$$

Analogo il test per l’effetto colonna.



### Caso con repliche ($l \ge 2$)

Con repliche si può stimare anche la componente di interazione. Le osservazioni sono:

$$
Y_{ijk} \sim \mathcal{N}(\mu + \alpha_i + \beta_j + \gamma_{ij},\ \sigma^2)
$$

Le devianze si calcolano come:

- **Devianza riga**:
  $$
  SS_R = n l \sum_i (\bar{Y}_{i**} - \bar{Y}_{***})^2
  $$

- **Devianza colonna**:
  $$
  SS_C = m l \sum_j (\bar{Y}_{*j*} - \bar{Y}_{***})^2
  $$

- **Devianza interazione**:
  $$
  SS_{Int} = l \sum_{i,j} (\bar{Y}_{ij*} - \bar{Y}_{i**} - \bar{Y}_{*j*} + \bar{Y}_{***})^2
  $$

- **Devianza errore**:
  $$
  SS_E = \sum_{i,j,k} (Y_{ijk} - \bar{Y}_{ij*})^2
  $$

Gradi di libertà associati:

| Fonte di variabilità | Gradi di libertà      |
|-|--|
| Riga                 | $m - 1$               |
| Colonna              | $n - 1$               |
| Interazione          | $(m - 1)(n - 1)$      |
| Errore               | $mn(l - 1)$           |
| Totale               | $mnl - 1$             |

Le statistiche dei test $F$:

- Per l’effetto riga:

$$
F_R = \frac{SS_R / (m - 1)}{SS_E / [mn(l - 1)]} \sim F(m-1, mn(l-1))
$$

- Per l’effetto colonna:

$$
F_C = \frac{SS_C / (n - 1)}{SS_E / [mn(l - 1)]} \sim F(n-1, mn(l-1))
$$

- Per l’interazione:

$$
F_{Int} = \frac{SS_{Int} / [(m - 1)(n - 1)]}{SS_E / [mn(l - 1)]} \sim F((m-1)(n-1), mn(l-1))
$$



### Stimatori

Per la varianza dell’errore (valido in entrambi i casi):

$$
\hat{\sigma}^2 = \frac{SS_E}{gdl_E}
$$

dove $gdl_E$ sono i gradi di libertà associati all’errore:
- $(m - 1)(n - 1)$ nel caso senza repliche
- $mn(l - 1)$ nel caso con repliche

Le medie campionarie, invece, sono:
- $\bar{Y}_{i**}$ = media dei dati nella riga $i$
- $\bar{Y}_{*j*}$ = media dei dati nella colonna $j$
- $\bar{Y}_{ij*}$ = media dei dati nella cella $(i,j)$
- $\bar{Y}_{***}$ = media globale di tutti i dati



### Considerazioni

Se il test sull’interazione non risulta significativo, è possibile utilizzare il modello additivo, più semplice da interpretare. In quel caso si possono anche ridurre i dati sostituendo le osservazioni con le medie per cella e applicare una ANOVA senza repliche.

Se invece l’interazione è significativa, bisogna mantenere il modello completo. In questo caso, l’interpretazione dei singoli effetti diventa più complessa, perché l’effetto di una variabile dipende dal livello dell’altra.

La correttezza dell’intera procedura dipende dalle ipotesi classiche dell’ANOVA: normalità dei residui, indipendenza e omoschedasticità.